Title: My trip through RabbitMQ clustering, now with more turbulences
Date: 2014-04-06 02:24
Tags: rabbitmq, queue, erlang, distributed, cluster
Category: queue
Slug: rabbitmq-clustering
Summary: How to set up a RabbitMQ cluster with a Firewall behind and non dynamic Erlang epmd ports.


######

rabbitmqctl join_cluster --ram rabbit@ip-10-158-xxx-xxx

Error: mnesia_unexpectedly_running


Make sure you call sudo rabbitmqctl stop_app before issuing the cluster command. That seemed to be the problem for me.

Then make sure you call sudo rabbitmqctl start_app to begin it again :)

######

erl -sname mytest -setcookie mycookie -kernel inet_dist_listen_min 44001 inet_dist_listen_max 44001

$ epmd -names
epmd: up and running on port 4369 with data:
name bar at port 30001
name foo at port 30000

#######

Port 4369 and dynamic ports in Erlang epmd

"4369 is the listen port for
epmd (erlang port mapper daemon).  This enables a node to discover
another named node.
"

####

For two Erlang nodes to be able to communicate they

- must have the same cookie (which, you say they do)

- must be able to resolve the other node's hostname to an IP

- must be able to connect to the Erlang port mapper daemon (epmd) on
that IP - it listens on port 4369 by default

- must be able to connect to the other node's distribution port. That
port is chosen dynamically (though you can "pin" it with -kernel
inet_dist_listen_min 4000 inet_dist_listen_max 4000) and returned by epmd.

As a first step in tracking down the problem I suggest you start some
test Erlang nodes on all your machines with
   erl -sname mytest -setcookie mycookie
and then evaluate
   net_adm:ping(mytest@<machine1>).
   net_adm:ping(mytest@<machine2>).
   ...
in each of the nodes, attempting to connect to the nodes on all other
machines.

The result of that will tell you which nodes have problems talking to
each other, and then you can use the above information about epmd etc to
investigate that further.


####################

# HEADER: This file was autogenerated at 2014-03-10 07:22:41 -0400
# HEADER: by puppet.  While it can still be managed manually, it
# HEADER: is definitely not recommended.
127.0.0.1   localhost
127.0.1.1   queue-tlv.tlv.wywy.com  queue-tlv

# The following lines are desirable for IPv6 capable hosts
::1 ip6-localhost   ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
172.20.10.3 puppet
10.200.1.4  files.muc.wywy.com
172.20.30.10    queue-us    queue-us.us.wywy.com
172.20.30.9 queue-tlv   queue-tlv.tlv.wywy.com
172.20.30.7 queue-muc   queue-muc.muc.wywy.com


####################

% This file managed by Puppet
% Template Path: rabbitmq/templates/rabbitmq.config
[
  {rabbit, [
    {cluster_nodes, {['rabbit@queue-tlv', 'rabbit@queue-muc'], disc}},
    {cluster_partition_handling, ignore},
    {default_user, <<"guest">>},
    {default_pass, <<"guest">>}
  ]},
  {kernel, [
    {inet_dist_listen_max, 44001},
    {inet_dist_listen_min, 44001}
  ]}
].
% EOF

###################
